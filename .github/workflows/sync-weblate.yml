name: Sync Weblate Commits

on:
  push:
    branches:
      - main

jobs:
  check-and-sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: List Weblate Commits
        id: weblate-commits
        run: |
          git fetch origin
          COMMITS=$(git log --format=%H --grep="Weblate" origin/main..)
          echo "{commits}={$COMMITS}" >> $GITHUB_OUTPUT

      - name: Check for Commits in Other Branches
        id: check-other-branches
        run: |
          OTHER_BRANCHES=$(git branch --format='%(refname:short)' | grep -v "main")
          MISSING_COMMITS=()
          MISSING_BRANCHES=()

          while IFS= read -r branch; do
              while IFS= read -r commit; do
                  if ! git branch --contains "$commit" | grep -q "$branch"; then
                      MISSING_COMMITS+=("$commit")
                      MISSING_BRANCHES+=("$branch")
                  fi
              done <<< "${{ steps.weblate-commits.outputs.commits }}"
          done <<< "$OTHER_BRANCHES"
          
          echo "{missing_commits}={MISSING_COMMITS[*]}" >> $GITHUB_OUTPUT
          echo "{missing_branches}={MISSING_BRANCHES[*]}" >> $GITHUB_OUTPUT

      - name: Pull Weblate Commits to Other Branches
        if: steps.check-other-branches.outputs.missing_commits != ''
        run: |
          MISSING_COMMITS=(${{ steps.check-other-branches.outputs.missing_commits }})
          MISSING_BRANCHES=(${{ steps.check-other-branches.outputs.missing_branches }})
          for ((i=0; i<${#MISSING_COMMITS[@]}; ++i)); do
            git checkout ${MISSING_BRANCHES[$i]}
            git cherry-pick ${MISSING_COMMITS[$i]}
          done
          git push origin $OTHER_BRANCHES
